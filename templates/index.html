<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="data:;base64,iVBORw0KGgo="> <!-- ì„ì‹œ faviconìœ¼ë¡œ 404 ì˜¤ë¥˜ ë°©ì§€ -->

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ìŠ¤í¬ë¦½íŠ¸: í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆë§Œ ë¡œë“œë©ë‹ˆë‹¤. -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <title>í™ˆ | ì•ˆë©´ê·¼ìœ¡ ì¬í™œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=SUIT:wght@400;600&display=swap" rel="stylesheet">
 <style>
  body {
    margin: 0;
    padding: 0;
    height: 100dvh;
    font-family: 'SUIT', sans-serif;
    background-color: white;
    color: #333;
    display: flex;
    flex-direction: column;
    opacity: 0; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ (ìŠ¤í¬ë¦½íŠ¸ë¡œ loaded í´ë˜ìŠ¤ ì¶”ê°€ ì‹œ í‘œì‹œ) */
    transition: opacity 0.4s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
  }

  body.loaded {
    opacity: 1;
  }

  body.fade-out {
    opacity: 0;
  }

  .home-button {
    position: fixed;
    top: 10px;
    left: 16px;
    background: #ff4081;
    color: white;
    padding: 4px 8px;
    font-weight: bold;
    border-radius: 6px;
    box-shadow: 0 0 8px #ff4081;
    z-index: 999;
    text-decoration: none;
    font-size: 14px;
  }

  /* ğŸ™ï¸ ìŒì„± í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .voice-toggle {
    position: fixed;
    top: 10px;
    right: 140px;
    z-index: 1000;
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.9);
    border: 2px solid #667eea;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
  }

  /* ğŸ†• ìŒì„± ì„¤ì • ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .voice-settings-toggle {
    position: fixed;
    top: 10px;
    right: 80px;
    z-index: 1000;
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.9);
    border: 2px solid #9333ea;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
  }

  .voice-settings-toggle:hover {
    background: #9333ea;
    color: white;
    transform: scale(1.1);
  }

  .voice-toggle:hover {
    background: #667eea;
    color: white;
    transform: scale(1.1);
  }

  .voice-toggle.speaking {
    animation: voicePulse 1s infinite;
    background: #f59e0b;
    border-color: #f59e0b;
    color: white;
  }

  .voice-toggle.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @keyframes voicePulse {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
    }
    50% {
      opacity: 0.8;
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
    }
  }

  /* ğŸ¯ ìŒì„± ê°€ì´ë“œ íŒ¨ë„ */
  .voice-guide-panel {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 12px;
    margin: 10px auto;
    max-width: 90%;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    text-align: center;
    transition: all 0.4s ease;
    position: fixed;
    top: 150px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 999;
  }

  .voice-guide-panel.hidden {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px);
    pointer-events: none;
  }

  /* ğŸ†• ìŠ¬ë¼ì´ë“œ ì—… ì• ë‹ˆë©”ì´ì…˜ */
  .voice-guide-panel.slide-up {
    animation: slideUpAndFade 0.6s ease-out forwards;
  }

  @keyframes slideUpAndFade {
    0% {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    100% {
      opacity: 0;
      transform: translateX(-50%) translateY(-30px);
    }
  }

  .guide-title {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .guide-content {
    font-size: 13px;
    line-height: 1.6;
    margin-bottom: 10px;
  }

  .guide-tips {
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 8px;
    font-size: 12px;
    border-left: 4px solid #fff;
  }

  /* ğŸ†• ìŒì„± ì„¤ì • íŒ¨ë„ */
  .voice-settings-panel {
    position: fixed;
    top: 60px;
    right: 20px;
    width: 280px;
    background: white;
    border: 2px solid #9333ea;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    z-index: 1001;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    pointer-events: none;
  }

  .voice-settings-panel.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
  }

  .settings-title {
    font-size: 18px;
    font-weight: bold;
    color: #9333ea;
    margin-bottom: 15px;
    text-align: center;
  }

  .setting-group {
    margin-bottom: 15px;
  }

  .setting-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
  }

  .setting-control {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
  }

  .setting-control:focus {
    outline: none;
    border-color: #9333ea;
    box-shadow: 0 0 5px rgba(147, 51, 234, 0.3);
  }

  .range-input {
    width: 100%;
    margin: 5px 0;
  }

  .range-value {
    font-size: 12px;
    color: #666;
    text-align: center;
  }

  .test-voice-btn, .save-settings-btn {
    width: 48%;
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
    margin-top: 10px;
  }

  .test-voice-btn {
    background: #3b82f6;
    color: white;
  }

  .test-voice-btn:hover {
    background: #2563eb;
  }

  .save-settings-btn {
    background: #10b981;
    color: white;
  }

  .save-settings-btn:hover {
    background: #059669;
  }

  .save-settings-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .settings-buttons {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    margin-top: 10px;
  }

  .close-settings-btn {
    position: absolute;
    top: 8px;
    right: 12px;
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #999;
  }

  .close-settings-btn:hover {
    color: #333;
  }
  /* ğŸ†• ESC í‚¤ ì•ˆë‚´ ìŠ¤íƒ€ì¼ */
  .esc-hint {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    z-index: 1001;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .esc-hint.show {
    opacity: 1;
  }

  @media screen and (min-width: 1024px), (hover: hover) and (pointer: fine) {
    .home-button {
      top: 24px;
      left: 24px;
      font-size: 20px;
      padding: 8px 16px;
    }

    .voice-toggle {
      top: 24px;
      right: 140px;
      width: 50px;
      height: 50px;
      font-size: 20px;
    }

    .voice-settings-toggle {
      top: 24px;
      right: 80px;
      width: 50px;
      height: 50px;
      font-size: 20px;
    }

    .voice-settings-panel {
      top: 85px;
      right: 24px;
      width: 320px;
    }

    .voice-guide-panel {
      padding: 20px;
      max-width: 600px;
      top: 140px;
    }

    .guide-title {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .guide-content {
      font-size: 14px;
      margin-bottom: 15px;
    }

    .guide-tips {
      padding: 15px;
      font-size: 13px;
    }

    .esc-hint {
      bottom: 30px;
      right: 30px;
      font-size: 14px;
      padding: 10px 15px;
    }
  }
</style>
</head>
<body>
  <!-- â–¼â–¼â–¼ [ì¶”ê°€] ì˜¤ë””ì˜¤ íŒŒì¼ ë¡œë“œ â–¼â–¼â–¼ -->
  <audio id="metal_click" src="/static/sounds/metal_click.mp3" preload="auto"></audio>
  <audio id="click_sound" src="/static/sounds/click_sound.wav" preload="auto"></audio>

  <!-- ë©”ì¸ ì½˜í…ì¸ ê°€ í‘œì‹œë  ì˜ì—­ -->
  <div id="app"></div>

  <!-- HOME ë²„íŠ¼ -->
  <a href="#" class="home-button" onclick="loadPage('index'); return false;">HOME</a>

  <!-- ğŸ™ï¸ ìŒì„± í† ê¸€ ë²„íŠ¼ ì¶”ê°€ -->
  <div class="voice-toggle" onclick="toggleVoice()" title="ìŒì„± ì•ˆë‚´ ì¼œê¸°/ë„ê¸° (ESCë¡œ ì¤‘ë‹¨)" id="voiceToggle">
    <span id="voiceIcon">ğŸ”‡</span>
  </div>

  <!-- ğŸ†• ìŒì„± ì„¤ì • ë²„íŠ¼ ì¶”ê°€ -->
  <div class="voice-settings-toggle" onclick="toggleVoiceSettings()" title="ìŒì„± ì„¤ì •" id="voiceSettingsToggle">
    <span>âš™ï¸</span>
  </div>

  <!-- ğŸ†• ìŒì„± ì„¤ì • íŒ¨ë„ (ëª©ì†Œë¦¬ ì„ íƒ ì œê±°ë¨) -->
  <div class="voice-settings-panel" id="voiceSettingsPanel">
    <button class="close-settings-btn" onclick="toggleVoiceSettings()">Ã—</button>
    <div class="settings-title">ğŸ™ï¸ ìŒì„± ì„¤ì •</div>

    <div class="setting-group">
      <label class="setting-label">ë§í•˜ëŠ” ì†ë„</label>
      <input type="range" class="range-input" id="rateRange" min="0.5" max="2" step="0.1" value="1">
      <div class="range-value" id="rateValue">1.0x</div>
    </div>

    <div class="setting-group">
      <label class="setting-label">ë³¼ë¥¨</label>
      <input type="range" class="range-input" id="volumeRange" min="0" max="1" step="0.1" value="0.8">
      <div class="range-value" id="volumeValue">80%</div>
    </div>

    <div class="setting-group">
      <label class="setting-label">ìŒì„± ë†’ë‚®ì´</label>
      <input type="range" class="range-input" id="pitchRange" min="0.5" max="2" step="0.1" value="1">
      <div class="range-value" id="pitchValue">1.0</div>
    </div>

    <div class="settings-buttons">
      <button class="test-voice-btn" onclick="testVoiceSettings()">
        ğŸ”Š í…ŒìŠ¤íŠ¸
      </button>
      <button class="save-settings-btn" onclick="saveVoiceSettings()" id="saveSettingsBtn">
        ğŸ’¾ ì €ì¥
      </button>
    </div>
  </div>

  <!-- ğŸ¯ ìŒì„± ê°€ì´ë“œ íŒ¨ë„ ì¶”ê°€ -->
  <div class="voice-guide-panel" id="voiceGuidePanel">
    <div class="guide-title">
      <span>ğŸ™ï¸</span>
      <span>ìŒì„± ì•ˆë‚´ë¡œ ë” ì‰½ê²Œ!</span>
    </div>
    <div class="guide-content">
      ìŠ¤ë§ˆì¼í•ì´ ì¹œê·¼í•œ ëª©ì†Œë¦¬ë¡œ ìš´ë™ì„ ë„ì™€ë“œë ¤ìš”!<br>
      ì˜¤ë¥¸ìª½ ìœ„ ìŠ¤í”¼ì»¤ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŒì„± ì•ˆë‚´ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.
    </div>
    <div class="guide-tips">
      ğŸ’¡ <strong>íŒ:</strong> ìŒì„± ì•ˆë‚´ëŠ” ì–¸ì œë“  ì¼œê³  ëŒ ìˆ˜ ìˆì–´ìš” â€¢ ESC í‚¤ë¡œ ì¤‘ë‹¨ ê°€ëŠ¥
    </div>
  </div>

  <!-- ğŸ†• ESC í‚¤ ì•ˆë‚´ -->
  <div class="esc-hint" id="escHint">
    ESC í‚¤ë¥¼ ëˆ„ë¥´ë©´ ìŒì„±ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤
  </div>

  <script>
    // â˜…â˜…â˜…â˜…â˜… [ìˆ˜ì •] í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œ ì´ˆê¸° ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. â˜…â˜…â˜…â˜…â˜…
    window.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('loaded');
      loadPage('index'); // ì´ˆê¸° í˜ì´ì§€ë¡œ index.htmlì„ ë¡œë“œí•©ë‹ˆë‹¤.

      // ìŒì„± ì‹œìŠ¤í…œ ì´ˆê¸°í™”
      voiceSystem = new SmileFitVoiceSystem('default');

      // ğŸ†• ìŒì„± ì„¤ì • ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      setupVoiceSettingsListeners();

      setTimeout(() => {
        // ìŒì„± ìƒíƒœ ì—…ë°ì´íŠ¸ (ê¸°ë³¸ê°’: êº¼ì§)
        voiceSystem.updateUI(false);

        // ğŸ†• ê¸°ë³¸ê°’ì´ êº¼ì ¸ìˆìœ¼ë¯€ë¡œ í™˜ì˜ ë©”ì‹œì§€ ì¬ìƒí•˜ì§€ ì•ŠìŒ
        console.log('ğŸ”‡ ìŒì„± ì•ˆë‚´ ê¸°ë³¸ê°’: êº¼ì§ ìƒíƒœ');
      }, 1000);
    });

    // â–¼â–¼â–¼ [ì¶”ê°€] ì‚¬ìš´ë“œ ì¬ìƒ í•¨ìˆ˜ â–¼â–¼â–¼
    function metalClickSound() {
      const sound = document.getElementById('metal_click');
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.warn("ì†Œë¦¬ ì¬ìƒ ì˜¤ë¥˜(metal_click):", e));
      }
    }

    function ClickSound() {
      const sound = document.getElementById('click_sound');
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.warn("ì†Œë¦¬ ì¬ìƒ ì˜¤ë¥˜(click_sound):", e));
      }
    }

    const routes = {
      'index': '/pages/index.html',
      'game_mode': '/pages/game_mode.html',
      'rehab_mode': '/pages/rehab_mode.html',
      'complex': '/pages/complex.html',
      'complex_fit': '/pages/complex_fit.html',
      'focus': '/pages/focus.html',
      'focus_fit': '/pages/focus_fit.html',
      'complex_feedback': '/pages/complex_feedback.html',
      'focus_feedback': '/pages/focus_feedback.html',
      'next_set_guidance': '/pages/next_set_guidance.html',
      'face_emotion': '/pages/face_emotion.html',
      'face_follow': '/pages/face_follow.html',
      'normal_feedback': '/pages/normal_feedback.html'
    };

    let currentModule = null;
    const pageCache = new Map();

    async function loadPage(routeKey) {
      const path = routes[routeKey];
      if (!path) {
        console.error(`ë¼ìš°íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${routeKey}`);
        return;
      }

      if (currentModule && typeof currentModule.cleanup === 'function') {
        try {
          currentModule.cleanup();
        } catch (e) { console.error("Cleanup ì˜¤ë¥˜:", e); }
      }
      currentModule = null;

      document.body.style.opacity = '0';

      setTimeout(async () => {
        try {
          let htmlContent;
          if (pageCache.has(routeKey)) {
            htmlContent = pageCache.get(routeKey);
          } else {
            const response = await fetch(path);
            if (!response.ok) throw new Error(`HTTP ${response.status} ì˜¤ë¥˜`);
            htmlContent = await response.text();
            pageCache.set(routeKey, htmlContent);
          }

          const appContainer = document.getElementById('app');
          appContainer.innerHTML = htmlContent;

          try {
            const version = new Date().getTime(); // ìºì‹œ ë°©ì§€ìš© íƒ€ì„ìŠ¤íƒ¬í”„
            const modulePath = `/scripts/${routeKey}.js?v=${version}`;
            const module = await import(modulePath);
            currentModule = module;
            if (module && typeof module.init === 'function') {
              console.log(`âœ… ${routeKey}.js ëª¨ë“ˆ ë¡œë“œ ì„±ê³µ. init() ì‹¤í–‰.`);
              module.init();
            }
          } catch (e) {
            if (!routeKey.startsWith("face_")) {
               console.warn(`'${routeKey}.js' ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ (ì •ìƒì¼ ìˆ˜ ìˆìŒ)`);
            } else {
               console.error(`'${routeKey}.js' ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨!`, e);
            }
          }

          document.body.style.opacity = '1';

          // ğŸ™ï¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ìŒì„± ì•ˆë‚´ (ê¸°ì¡´ ìŒì„± ì¤‘ë‹¨í•˜ê³  ìƒˆ ë©”ì‹œì§€ ì¬ìƒ)
          if (voiceSystem && voiceSystem.isEnabled) {
            // ê¸°ì¡´ ìŒì„± ì¦‰ì‹œ ì¤‘ë‹¨
            voiceSystem.stop();
            // ìƒˆ í˜ì´ì§€ ìŒì„± ì•ˆë‚´ (ìš°ì„ ìˆœìœ„ highë¡œ ì¦‰ì‹œ ì¬ìƒ)
            setTimeout(() => {
              announcePageLoad(routeKey);
            }, 200); // ì§§ì€ ë”œë ˆì´ë¡œ ë¶€ë“œëŸ½ê²Œ ì „í™˜
          }

        } catch (error) {
          console.error(`âŒ í˜ì´ì§€ ë¡œë”© ì‹¤íŒ¨ [${routeKey}]:`, error);
          document.body.style.opacity = '1';
        }
      }, 400);
    }

    // ğŸ™ï¸ SMILE FIT í†µí•© ìŒì„± ì‹œìŠ¤í…œ
    class SmileFitVoiceSystem {
      constructor(pageType = 'default') {
        this.synthesis = window.speechSynthesis;
        this.isEnabled = localStorage.getItem('smileFitVoiceEnabled') === 'true'; // ê¸°ë³¸ê°’: false (êº¼ì§)
        this.pageType = pageType;
        this.settings = this.getSettingsForPage(pageType);
        this.currentUtterance = null;
        this.isInitialized = false;
        this.isSpeaking = false;

        this.initVoices();
        this.setupKeyboardListeners(); // ğŸ†• í‚¤ë³´ë“œ ë¦¬ìŠ¤ë„ˆ ì„¤ì •

        console.log(`ğŸ™ï¸ SMILE FIT ìŒì„± ì‹œìŠ¤í…œ ì´ˆê¸°í™”: ${pageType} ëª¨ë“œ (ê¸°ë³¸ê°’: êº¼ì§)`);
      }

      // í˜ì´ì§€ë³„ ìŒì„± ì„¤ì •
      getSettingsForPage(pageType) {
        const savedSettings = this.loadUserSettings();

        const defaultSettings = {
          default: { rate: 1.0, volume: 0.8, pitch: 1.0 },
          game: { rate: 1.1, volume: 0.9, pitch: 1.1 },
          rehab: { rate: 0.9, volume: 0.8, pitch: 1.0 },
          exercise: { rate: 0.8, volume: 0.9, pitch: 1.0 }
        };

        const baseSettings = defaultSettings[pageType] || defaultSettings.default;
        return { ...baseSettings, ...savedSettings, lang: 'ko-KR' };
      }

      // ğŸ†• ì‚¬ìš©ì ì„¤ì • ì €ì¥
      saveUserSettings() {
        const settings = {
          rate: this.settings.rate,
          volume: this.settings.volume,
          pitch: this.settings.pitch
        };
        localStorage.setItem('smileFitVoiceSettings', JSON.stringify(settings));
      }

      // ğŸ†• ì‚¬ìš©ì ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
      loadUserSettings() {
        try {
          const saved = localStorage.getItem('smileFitVoiceSettings');
          return saved ? JSON.parse(saved) : {};
        } catch (e) {
          console.warn('ìŒì„± ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
          return {};
        }
      }

      // ğŸ†• ì„¤ì • ì—…ë°ì´íŠ¸ (ì„ì‹œ ì ìš©)
      updateSettingsTemporary(newSettings) {
        Object.assign(this.settings, newSettings);
        console.log('ğŸ›ï¸ ìŒì„± ì„¤ì • ì„ì‹œ ì ìš©:', newSettings);
      }

      // ğŸ†• ì„¤ì • ì—…ë°ì´íŠ¸ ë° ì €ì¥
      updateSettingsAndSave(newSettings) {
        Object.assign(this.settings, newSettings);
        this.saveUserSettings();
        console.log('ğŸ›ï¸ ìŒì„± ì„¤ì • ì €ì¥ ì™„ë£Œ:', newSettings);
      }

      // ğŸ†• í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      setupKeyboardListeners() {
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && this.isSpeaking) {
            console.log('ğŸ”‡ ESC í‚¤ë¡œ ìŒì„± ì¤‘ë‹¨');
            this.stop();
            this.showEscHint(false); // ESC íŒíŠ¸ ìˆ¨ê¹€
          }
        });
      }

      // ğŸ†• ESC íŒíŠ¸ í‘œì‹œ/ìˆ¨ê¹€
      showEscHint(show) {
        const escHint = document.getElementById('escHint');
        if (!escHint) return;

        if (show) {
          escHint.classList.add('show');
        } else {
          escHint.classList.remove('show');
        }
      }

      // ìŒì„± ì´ˆê¸°í™”
      initVoices() {
        const loadVoices = () => {
          this.voices = this.synthesis.getVoices();
          this.koreanVoice = this.voices.find(voice =>
            voice.lang.includes('ko') ||
            voice.name.includes('Korean') ||
            voice.name.includes('í•œêµ­')
          );

          if (this.koreanVoice) {
            this.settings.voice = this.koreanVoice;
          }

          this.isInitialized = true;

          console.log(`ğŸ™ï¸ ìŒì„± ë¡œë“œ ì™„ë£Œ: ${this.voices.length}ê°œ ìŒì„± ì‚¬ìš© ê°€ëŠ¥`);
          if (this.koreanVoice) {
            console.log(`ğŸ‡°ğŸ‡· í•œêµ­ì–´ ìŒì„± ì„ íƒ: ${this.koreanVoice.name}`);
          }
        };

        if (this.synthesis.getVoices().length > 0) {
          loadVoices();
        } else {
          this.synthesis.onvoiceschanged = loadVoices;
        }
      }

      // ìŒì„± ì¶œë ¥
      speak(text, callback = null, priority = 'normal') {
        if (!this.isEnabled || !this.synthesis) {
          console.log('ğŸ”‡ ìŒì„± ì•ˆë‚´ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
          return;
        }

        if (priority === 'high' || priority === 'page_change') {
          this.synthesis.cancel();
          this.isSpeaking = false;
        }
        else if (this.isSpeaking) {
          console.log('ğŸ”‡ ì´ë¯¸ ìŒì„±ì´ ì¬ìƒ ì¤‘ì…ë‹ˆë‹¤');
          return;
        }

        this.currentUtterance = new SpeechSynthesisUtterance(text);
        Object.assign(this.currentUtterance, this.settings);

        if (this.settings.voice) {
          this.currentUtterance.voice = this.settings.voice;
        } else if (this.koreanVoice) {
          this.currentUtterance.voice = this.koreanVoice;
        }

        this.currentUtterance.onstart = () => {
          this.isSpeaking = true;
          this.updateUI(true);
          this.showEscHint(true);
          console.log('ğŸ—£ï¸ ìŒì„± ì¬ìƒ ì‹œì‘:', text.substring(0, 30) + '...');
        };

        this.currentUtterance.onend = () => {
          this.isSpeaking = false;
          this.updateUI(false);
          this.showEscHint(false);
          console.log('âœ… ìŒì„± ì¬ìƒ ì™„ë£Œ');
          if (callback) callback();
        };

        this.currentUtterance.onerror = (event) => {
          this.isSpeaking = false;
          this.updateUI(false);
          this.showEscHint(false);
          console.error('âŒ ìŒì„± ì¬ìƒ ì˜¤ë¥˜:', event.error);
        };

        this.synthesis.speak(this.currentUtterance);
      }

      // ìŒì„± ì•ˆë‚´ ì¼œê¸°/ë„ê¸°
      toggle() {
        this.isEnabled = !this.isEnabled;
        localStorage.setItem('smileFitVoiceEnabled', this.isEnabled);

        if (!this.isEnabled) {
          this.stop();
        }

        this.updateUI(false);
        console.log('ğŸ›ï¸ ìŒì„± ì•ˆë‚´:', this.isEnabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”');

        this.toggleGuidePanel();

        return this.isEnabled;
      }

      // ìŒì„± ì¤‘ì§€
      stop() {
        this.synthesis.cancel();
        this.isSpeaking = false;
        this.updateUI(false);
        this.showEscHint(false);
      }

      // UI ì—…ë°ì´íŠ¸
      updateUI(isSpeaking) {
        const toggle = document.getElementById('voiceToggle');
        const icon = document.getElementById('voiceIcon');

        if (!toggle || !icon) return;

        if (isSpeaking) {
          toggle.classList.add('speaking');
          icon.textContent = 'ğŸ”Š';
        } else {
          toggle.classList.remove('speaking');
          icon.textContent = this.isEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
        }

        if (!this.isSupported()) {
          toggle.classList.add('disabled');
          icon.textContent = 'âŒ';
        }
      }

      // ğŸ†• ê°€ì´ë“œ íŒ¨ë„ í† ê¸€
      toggleGuidePanel() {
        const panel = document.getElementById('voiceGuidePanel');
        if (!panel) return;

        if (this.isEnabled) {
          panel.classList.add('slide-up');
          setTimeout(() => {
            panel.classList.add('hidden');
            panel.classList.remove('slide-up');
          }, 600);
        } else {
          panel.classList.remove('hidden', 'slide-up');
        }
      }

      // ë¸Œë¼ìš°ì € ì§€ì› ì—¬ë¶€ í™•ì¸
      isSupported() {
        return 'speechSynthesis' in window;
      }
    }

    // ì „ì—­ ìŒì„± ì‹œìŠ¤í…œ ì¸ìŠ¤í„´ìŠ¤
    let voiceSystem = null;

    // ğŸ†• ìŒì„± ì„¤ì • íŒ¨ë„ í† ê¸€
    function toggleVoiceSettings() {
      const panel = document.getElementById('voiceSettingsPanel');
      if (!panel) return;

      panel.classList.toggle('show');

      if (panel.classList.contains('show') && voiceSystem) {
        updateSettingsUI();
        const saveBtn = document.getElementById('saveSettingsBtn');
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.textContent = 'ğŸ’¾ ì €ì¥';
          saveBtn.style.background = '#9ca3af';
        }
      }
    }

    // ğŸ†• ì„¤ì • UI ì—…ë°ì´íŠ¸
    function updateSettingsUI() {
      if (!voiceSystem) return;

      const rateRange = document.getElementById('rateRange');
      const volumeRange = document.getElementById('volumeRange');
      const pitchRange = document.getElementById('pitchRange');
      const rateValue = document.getElementById('rateValue');
      const volumeValue = document.getElementById('volumeValue');
      const pitchValue = document.getElementById('pitchValue');

      if (rateRange) {
        rateRange.value = voiceSystem.settings.rate;
        if (rateValue) rateValue.textContent = voiceSystem.settings.rate + 'x';
      }
      if (volumeRange) {
        volumeRange.value = voiceSystem.settings.volume;
        if (volumeValue) volumeValue.textContent = Math.round(voiceSystem.settings.volume * 100) + '%';
      }
      if (pitchRange) {
        pitchRange.value = voiceSystem.settings.pitch;
        if (pitchValue) pitchValue.textContent = voiceSystem.settings.pitch.toFixed(1);
      }
    }

    // ğŸ†• ìŒì„± ì„¤ì • í…ŒìŠ¤íŠ¸
    function testVoiceSettings() {
      if (!voiceSystem) return;

      const rate = parseFloat(document.getElementById('rateRange').value);
      const volume = parseFloat(document.getElementById('volumeRange').value);
      const pitch = parseFloat(document.getElementById('pitchRange').value);

      const newSettings = { rate, volume, pitch };
      voiceSystem.updateSettingsTemporary(newSettings);
      voiceSystem.speak('ìŒì„± í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.', null, 'high');
      enableSaveButton();
    }

    // ğŸ†• ìŒì„± ì„¤ì • ì €ì¥
    function saveVoiceSettings() {
      if (!voiceSystem) return;

      const rate = parseFloat(document.getElementById('rateRange').value);
      const volume = parseFloat(document.getElementById('volumeRange').value);
      const pitch = parseFloat(document.getElementById('pitchRange').value);

      const newSettings = { rate, volume, pitch };
      voiceSystem.updateSettingsAndSave(newSettings);

      const saveBtn = document.getElementById('saveSettingsBtn');
      if (saveBtn) {
        saveBtn.textContent = 'âœ… ì €ì¥ì™„ë£Œ';
        saveBtn.style.background = '#059669';

        setTimeout(() => {
          saveBtn.textContent = 'ğŸ’¾ ì €ì¥';
          saveBtn.style.background = '#10b981';
          saveBtn.disabled = true;
        }, 2000);
      }

      setTimeout(() => {
        voiceSystem.speak('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', null, 'high');
      }, 500);
    }

    // ğŸ†• ì €ì¥ ë²„íŠ¼ í™œì„±í™” í•¨ìˆ˜
    function enableSaveButton() {
      const saveBtn = document.getElementById('saveSettingsBtn');
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ğŸ’¾ ì €ì¥';
        saveBtn.style.background = '#10b981';
      }
    }

    // ğŸ†• ì„¤ì • ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
    function setupVoiceSettingsListeners() {
      const rateRange = document.getElementById('rateRange');
      const volumeRange = document.getElementById('volumeRange');
      const pitchRange = document.getElementById('pitchRange');

      if (rateRange) {
        rateRange.addEventListener('input', (e) => {
          document.getElementById('rateValue').textContent = e.target.value + 'x';
          enableSaveButton();
        });
      }

      if (volumeRange) {
        volumeRange.addEventListener('input', (e) => {
          document.getElementById('volumeValue').textContent = Math.round(e.target.value * 100) + '%';
          enableSaveButton();
        });
      }

      if (pitchRange) {
        pitchRange.addEventListener('input', (e) => {
          document.getElementById('pitchValue').textContent = parseFloat(e.target.value).toFixed(1);
          enableSaveButton();
        });
      }

      document.addEventListener('click', (e) => {
        const panel = document.getElementById('voiceSettingsPanel');
        const toggle = document.getElementById('voiceSettingsToggle');

        if (panel && panel.classList.contains('show') &&
            !panel.contains(e.target) && !toggle.contains(e.target)) {
          panel.classList.remove('show');
        }
      });
    }

    // ğŸ”§ ìŒì„± í† ê¸€ í•¨ìˆ˜
    function toggleVoice() {
      if (!voiceSystem) {
        console.error('âŒ ìŒì„± ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
        return;
      }

      if (!voiceSystem.isSupported()) {
        alert('ì£„ì†¡í•©ë‹ˆë‹¤. ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì•ˆë‚´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nChrome, Edge, Firefoxë¥¼ ì‚¬ìš©í•˜ì‹œê±°ë‚˜ ë¸Œë¼ìš°ì €ë¥¼ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.');
        return;
      }

      const isEnabled = voiceSystem.toggle();

      if (isEnabled) {
        voiceSystem.speak('ìŒì„± ì•ˆë‚´ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ìŠ¤ë§ˆì¼í•ê³¼ í•¨ê»˜ ê±´ê°•í•œ í‘œì • ìš´ë™ì„ í•´ë³´ì„¸ìš”!', null, 'high');
      } else {
        voiceSystem.stop();
      }
    }

    // ğŸ™ï¸ í˜ì´ì§€ë³„ ìŒì„± ì•ˆë‚´ í•¨ìˆ˜
    function announcePageLoad(routeKey) {
      const announcements = {
        'index': 'ìŠ¤ë§ˆì¼í•ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ê²Œì„ ëª¨ë“œì™€ ì¬í™œ ëª¨ë“œ ì¤‘ ì›í•˜ëŠ” ê²ƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.',
        'game_mode': 'ê²Œì„ ëª¨ë“œì…ë‹ˆë‹¤. í‘œì • ë”°ë¼í•˜ê¸°ì™€ ê°ì • í‘œí˜„í•˜ê¸° ì¤‘ ì„ íƒí•´ì£¼ì„¸ìš”.',
        'rehab_mode': 'ì¬í™œ ëª¨ë“œì…ë‹ˆë‹¤. ì§‘ì¤‘ìš´ë™ê³¼ ë³µí•©ìš´ë™ ì¤‘ ì„ íƒí•´ì£¼ì„¸ìš”.',
        'complex': 'ë³µí•©ìš´ë™ ì„ ìƒë‹˜ ì„ íƒ í™”ë©´ì…ë‹ˆë‹¤. í•¨ê»˜ ìš´ë™í•  ì„ ìƒë‹˜ì„ ê³¨ë¼ì£¼ì„¸ìš”.',
        'focus': 'ì§‘ì¤‘ìš´ë™ ë¶€ìœ„ ì„ íƒ í™”ë©´ì…ë‹ˆë‹¤. ìš´ë™í•  ë¶€ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.',
        'complex_fit': 'ë³µí•©ìš´ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤. í™”ë©´ì˜ ê¸°ì¤€ ì´ë¯¸ì§€ë¥¼ ë³´ê³  ë”°ë¼í•´ì£¼ì„¸ìš”.',
        'focus_fit': 'ì§‘ì¤‘ìš´ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤. í™”ë©´ì˜ ê¸°ì¤€ ì´ë¯¸ì§€ë¥¼ ë³´ê³  ë”°ë¼í•´ì£¼ì„¸ìš”.',
        'complex_feedback': 'ë³µí•©ìš´ë™ ê²°ê³¼ì…ë‹ˆë‹¤. ìƒì„¸í•œ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.',
        'focus_feedback': 'ì§‘ì¤‘ìš´ë™ ê²°ê³¼ì…ë‹ˆë‹¤. ìƒì„¸í•œ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.'
      };

      const message = announcements[routeKey];
      if (message) {
        setTimeout(() => {
          voiceSystem.speak(message, null, 'page_change');
        }, 300);
      }
    }

    // ğŸ§ª ê°œë°œì ë„êµ¬ìš© ë””ë²„ê¹… í•¨ìˆ˜
    window.debugVoice = {
      status: () => voiceSystem ? voiceSystem.getStatus() : 'Not initialized',
      speak: (text) => voiceSystem ? voiceSystem.speak(text, null, 'high') : 'Not initialized',
      toggle: () => toggleVoice(),
      stop: () => voiceSystem ? voiceSystem.stop() : 'Not initialized'
    };

    console.log('ğŸ™ï¸ SMILE FIT SPA ìŒì„± ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ!');
    console.log('ğŸ’¡ ê°œë°œì ë„êµ¬ì—ì„œ window.debugVoiceë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥');

  </script>
</body>
</html>